<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .connected { background: #4CAF50; }
        .disconnected { background: #f44336; }
        .connecting { background: #FF9800; }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #1976D2; }
        #log {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üöÄ Railway WebSocket Test</h1>
    
    <div id="status" class="status connecting">üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
    
    <div>
        <button onclick="connect()">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button onclick="disconnect()">‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button onclick="testJoinSession()">üéÆ –¢–µ—Å—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</button>
        <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>
    
    <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:</h3>
    <div id="info"></div>
    
    <h3>üìù –õ–æ–≥:</h3>
    <div id="log"></div>

    <script>
        let ws = null;
        let isConnected = false;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(status, className) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = status;
            statusDiv.className = `status ${className}`;
        }

        function updateInfo() {
            const infoDiv = document.getElementById('info');
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            
            let wsUrl;
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                wsUrl = `${protocol}//${window.location.hostname}:5000`;
            } else {
                wsUrl = `${protocol}//${window.location.host}`;
            }

            infoDiv.innerHTML = `
                <strong>üåê –¢–µ–∫—É—â–∏–π URL:</strong> ${window.location.href}<br>
                <strong>üè† Hostname:</strong> ${window.location.hostname}<br>
                <strong>üîí Protocol:</strong> ${window.location.protocol}<br>
                <strong>üîó WebSocket URL:</strong> ${wsUrl}<br>
                <strong>üéØ Environment:</strong> ${window.location.hostname === 'localhost' ? 'Development' : 'Production'}<br>
                <strong>üì° Status:</strong> ${isConnected ? 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω' : 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω'}
            `;
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('‚ö†Ô∏è –£–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                return;
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            
            let wsUrl;
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                wsUrl = `${protocol}//${window.location.hostname}:5000`;
            } else {
                wsUrl = `${protocol}//${window.location.host}`;
            }

            log(`üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫: ${wsUrl}`);
            updateStatus('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'connecting');

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    updateStatus('üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω', 'connected');
                    isConnected = true;
                    updateInfo();
                };

                ws.onmessage = (event) => {
                    log(`üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${event.data}`);
                    try {
                        const data = JSON.parse(event.data);
                        log(`üìã Parsed data: ${JSON.stringify(data, null, 2)}`);
                    } catch (e) {
                        log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON: ${e.message}`);
                    }
                };

                ws.onclose = (event) => {
                    log(`‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω. Code: ${event.code}, Reason: ${event.reason}`);
                    updateStatus('üî¥ –û—Ç–∫–ª—é—á–µ–Ω', 'disconnected');
                    isConnected = false;
                    updateInfo();
                };

                ws.onerror = (error) => {
                    log(`üí• WebSocket –æ—à–∏–±–∫–∞: ${error}`);
                    log(`üîó URL: ${wsUrl}`);
                    log(`üåê Location: ${window.location.href}`);
                    updateStatus('üí• –û—à–∏–±–∫–∞', 'disconnected');
                    isConnected = false;
                    updateInfo();
                };

            } catch (error) {
                log(`üí• –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket: ${error.message}`);
                updateStatus('üí• –û—à–∏–±–∫–∞', 'disconnected');
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            log('üîå –û—Ç–∫–ª—é—á–µ–Ω–∏–µ...');
        }

        function testJoinSession() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ö†Ô∏è WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                return;
            }

            const testMessage = {
                type: 'join_session',
                sessionId: 'a2f9a25c-03cf-4758-93c1-791a28bc139a',
                tableId: 1,
                playerId: 1,
                playerName: 'TestPlayer'
            };

            log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ${JSON.stringify(testMessage, null, 2)}`);
            ws.send(JSON.stringify(testMessage));
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            updateInfo();
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                connect();
            }, 1000);
        };
    </script>
</body>
</html> 